<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æœå·¥ä½œå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        .container-fluid {
            height: 100vh;
            display: flex;
        }
        /* å·¦ä¾§ç”¨æˆ·åˆ—è¡¨ */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            background: #f8f9fa;
        }
        .sidebar-header h5 {
            margin: 0;
            font-size: 16px;
        }
        .mini-app-info {
            padding: 10px 15px;
            background: #fff3cd;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
        }
        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .user-item {
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .user-item:hover {
            background: #f0f0f0;
        }
        .user-item.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .user-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .user-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }
        .user-last-msg {
            font-size: 12px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .badge {
            background: red;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }
        /* å³ä¾§èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            background: #f8f9fa;
        }
        .chat-header h5 {
            margin: 0;
            font-size: 16px;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f5f5f5;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
        }
        .message.user {
            justify-content: flex-start;
        }
        .message.cs {
            justify-content: flex-end;
        }
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 5px;
            word-wrap: break-word;
        }
        .message.user .message-content {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }
        .message.cs .message-content {
            background: #007bff;
            color: white;
        }
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        .message-image {
            max-width: 200px;
            border-radius: 4px;
            cursor: pointer;
        }
        .chat-input {
            padding: 15px;
            border-top: 1px solid #ddd;
            background: white;
        }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .input-group textarea {
            flex: 1;
            min-height: 80px;
            max-height: 200px;
            resize: vertical;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            line-height: 1.5;
        }
        .input-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        .file-input-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
        }
        .file-input-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #999;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç™»å½•é¡µé¢ -->
        <div v-if="!loggedIn" style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #f5f5f5;">
            <div style="width: 400px; background: white; padding: 30px; border: 1px solid #ddd; border-radius: 4px;">
                <h3 style="text-align: center; margin-bottom: 20px;">å®¢æœç™»å½•</h3>
                <div v-if="error" class="alert alert-danger">{{ error }}</div>
                <div class="mb-3">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input v-model="csName" class="form-control" @keyup.enter="login">
                </div>
                <div class="mb-3">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" v-model="csPass" class="form-control" @keyup.enter="login">
                </div>
                <button @click="login" class="btn btn-primary w-100" :disabled="loading">
                    {{ loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
                </button>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div v-else class="container-fluid">
            <!-- å·¦ä¾§ç”¨æˆ·åˆ—è¡¨ -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h5>ç”¨æˆ·åˆ—è¡¨</h5>
                    <div style="float: right; margin-top: -25px; display: flex; gap: 5px;">
                        <button @click="showWelcomeModal = true" class="btn btn-sm btn-success" title="è®¾ç½®æ¬¢è¿è¯­">æ¬¢è¿è¯­</button>
                        <button @click="showQRCode = !showQRCode" class="btn btn-sm btn-info" title="æ˜¾ç¤ºäºŒç»´ç ">äºŒç»´ç </button>
                        <button @click="logout" class="btn btn-sm btn-secondary">é€€å‡º</button>
                    </div>
                </div>
                <div class="mini-app-info">
                    <strong>åˆ†é…çš„å°ç¨‹åºï¼š</strong>
                    <span v-if="miniApps && miniApps.length > 0">
                        <span v-for="(app, index) in miniApps" :key="app.ID">
                            {{ app.Name || app.AppID }}<span v-if="index < miniApps.length - 1">, </span>
                        </span>
                    </span>
                    <span v-else style="color: red;">æœªåˆ†é…</span>
                </div>
                <div class="user-list">
                    <div v-if="!users || users.length === 0" class="empty-state">
                        æš‚æ— ç”¨æˆ·
                    </div>
                    <div v-for="user in (users || [])" :key="user.ID" 
                         :class="['user-item', { active: selectedUserId === user.ID }]"
                         @click="selectUser(user)"
                         @contextmenu.prevent="showDeleteUserOption(user, $event)">
                        <div class="user-name" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>ç”¨æˆ· #{{ user.ID }}
                                <span v-if="user.IsOnline" style="margin-left: 8px; font-size: 12px; color: #28a745; font-weight: normal;">åœ¨çº¿</span>
                                <span v-else style="margin-left: 8px; font-size: 12px; color: #6c757d; font-weight: normal;">ç¦»çº¿</span></span>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <span v-if="user.Subscribed" style="font-size: 11px; color: #28a745; background: #d4edda; padding: 2px 6px; border-radius: 3px;">å·²æˆæƒ</span>
                                <span v-if="user.UnreadCount > 0" class="badge">{{ user.UnreadCount }}</span>
                            </div>
                        </div>
                        <div class="user-meta">å°ç¨‹åº: {{ user.MiniAppName }}</div>
                        <div v-if="user.LastMessage" class="user-last-msg">{{ user.LastMessage }}</div>
                        <div v-if="user.LastMessageTime" class="user-meta" style="font-size: 11px;">{{ user.LastMessageTime }}</div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
            <div class="chat-area">
                <div class="chat-header">
                    <h5 v-if="selectedUser">ä¸ç”¨æˆ· #{{ selectedUser.ID }} å¯¹è¯ ({{ selectedUser.MiniAppName }})</h5>
                    <h5 v-else style="color: #999;">è¯·é€‰æ‹©ç”¨æˆ·</h5>
                </div>
                <div class="messages" ref="messagesContainer">
                    <div v-if="!selectedUser" class="empty-state">
                        è¯·ä»å·¦ä¾§é€‰æ‹©ç”¨æˆ·å¼€å§‹å¯¹è¯
                    </div>
                    <div v-else>
                        <div v-for="msg in (messages || [])" :key="msg.ID" 
                             :class="['message', msg.FromUser ? 'user' : 'cs']">
                            <div class="message-content">
                                <span v-if="!msg.IsImage">{{ msg.Content }}</span>
                                <img v-else :src="msg.ImageURL" alt="å›¾ç‰‡" class="message-image" @click="viewImage(msg.ImageURL)">
                                <div class="message-time">{{ formatTime(msg.CreatedAt) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="selectedUser" class="chat-input">
                    <div style="margin-bottom: 8px; display: flex; gap: 8px; justify-content: flex-end;">
                        <button @click="requestPushAuth" class="btn btn-sm btn-info" style="font-size: 12px; padding: 4px 12px;" title="ç›´æ¥æ¨é€è®¢é˜…æ¶ˆæ¯ç»™ç”¨æˆ·ï¼Œè®©ç”¨æˆ·åœ¨å¾®ä¿¡æ”¶åˆ°é€šçŸ¥">
                            ğŸ“¢ æ¨é€æé†’
                        </button>
                    </div>
                    <div class="input-group">
                        <textarea 
                            v-model="message" 
                            placeholder="è¾“å…¥æ¶ˆæ¯...ï¼ˆæ”¯æŒç²˜è´´å’Œæ‹–æ‹½å›¾ç‰‡ï¼‰" 
                            @keydown.enter.exact.prevent="sendMessage"
                            @paste="handlePaste"
                            @drop="handleDrop"
                            @dragover.prevent
                            @dragenter.prevent
                            ref="messageInput"></textarea>
                        <div class="file-input-wrapper">
                            <input type="file" @change="sendImage" accept="image/*" ref="fileInput" id="fileInput">
                            <button type="button" class="file-input-btn" @click="$refs.fileInput.click()" title="é€‰æ‹©å›¾ç‰‡">
                                ğŸ“
                            </button>
                        </div>
                        <button @click="sendMessage" class="btn btn-primary" :disabled="!message.trim()" style="height: 40px;">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡æŸ¥çœ‹ -->
        <div v-if="viewingImage" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;" @click="viewingImage = null">
            <div style="background: white; padding: 20px; border-radius: 4px; max-width: 90%; max-height: 90%;">
                <button @click="viewingImage = null" style="float: right; margin-bottom: 10px;">å…³é—­</button>
                <img :src="viewingImage" alt="å›¾ç‰‡" style="max-width: 100%; max-height: 80vh;">
            </div>
        </div>

        <!-- äºŒç»´ç å¼¹çª— -->
        <div v-if="showQRCode" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center;" @click="showQRCode = false">
            <div style="background: white; padding: 30px; border-radius: 8px; max-width: 400px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);" @click.stop>
                <h5 style="margin: 0 0 20px 0; color: #333;">å°ç¨‹åºäºŒç»´ç </h5>
                <div v-if="qrCodeLoading" style="padding: 40px; color: #666;">åŠ è½½ä¸­...</div>
                <div v-else-if="qrCodeError" style="padding: 40px; color: #dc3545;">{{ qrCodeError }}</div>
                <img v-else-if="qrCodeUrl" :src="qrCodeUrl" alt="å°ç¨‹åºäºŒç»´ç " style="max-width: 300px; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 4px;">
                <div v-else style="padding: 40px; color: #999;">æœªè®¾ç½®äºŒç»´ç è·¯å¾„ï¼Œè¯·è”ç³»ç®¡ç†å‘˜è®¾ç½®</div>
                <button @click="showQRCode = false" style="margin-top: 20px; padding: 8px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>
            </div>
        </div>

        <!-- æ¬¢è¿è¯­è®¾ç½®å¼¹çª— -->
        <div v-if="showWelcomeModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center;" @click="showWelcomeModal = false">
            <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);" @click.stop>
                <h5 style="margin: 0 0 20px 0; color: #333;">è®¾ç½®æ¬¢è¿è¯­</h5>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">ç”¨æˆ·é¦–æ¬¡å‘é€æ¶ˆæ¯æ—¶ï¼Œå°†è‡ªåŠ¨å‘é€æ­¤æ¬¢è¿è¯­</p>
                <textarea 
                    v-model="welcomeMessage" 
                    placeholder="è¯·è¾“å…¥æ¬¢è¿è¯­..." 
                    style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;"
                    rows="5"></textarea>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button @click="showWelcomeModal = false" style="padding: 8px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                    <button @click="saveWelcomeMessage" style="padding: 8px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    loggedIn: false,
                    csName: '',
                    csPass: '',
                    csId: null,
                    loading: false,
                    error: '',
                    miniApps: [],
                    users: [],
                    selectedUser: null,
                    selectedUserId: null,
                    messages: [],
                    message: '',
                    ws: null,
                    viewingImage: null,
                    showQRCode: false,
                    qrCodeUrl: '',
                    qrCodeLoading: false,
                    qrCodeError: '',
                    showWelcomeModal: false,
                    welcomeMessage: '',
                    userListRefreshTimer: null,
                    miniApps: []
                };
            },
            watch: {
                showQRCode(newVal) {
                    if (newVal) {
                        this.loadQRCode();
                    } else {
                        this.qrCodeUrl = '';
                        this.qrCodeError = '';
                    }
                }
            },
            mounted() {
                // ä» localStorage æ¢å¤ç™»å½•çŠ¶æ€
                const savedCsId = localStorage.getItem('csId');
                const savedCsName = localStorage.getItem('csName');
                if (savedCsId && savedCsName) {
                    this.loggedIn = true;
                    this.csId = parseInt(savedCsId);
                    this.csName = savedCsName;
                    this.loadData();
                    this.connectWebSocket();
                }
            },
            methods: {
                async login() {
                    if (!this.csName || !this.csPass) {
                        this.error = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                        return;
                    }
                    this.loading = true;
                    this.error = '';
                    try {
                        const response = await fetch('https://kefu.chacaitx.cn/api/admin/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ Name: this.csName, Password: this.csPass })
                        });
                        const data = await response.json();
                        if (data.csId) {
                            this.loggedIn = true;
                            this.csId = data.csId;
                            // ä¿å­˜ç™»å½•çŠ¶æ€åˆ° localStorage
                            localStorage.setItem('csId', this.csId.toString());
                            localStorage.setItem('csName', this.csName);
                            this.loadData();
                            this.connectWebSocket();
                            this.loadWelcomeMessage();
                        } else {
                            this.error = data.error || 'ç™»å½•å¤±è´¥';
                        }
                    } catch (err) {
                        this.error = 'ç½‘ç»œé”™è¯¯: ' + err.message;
                    } finally {
                        this.loading = false;
                    }
                },
                async loadData() {
                    await Promise.all([
                        this.loadMiniApps(),
                        this.loadUsers()
                    ]);
                },
                async loadMiniApps() {
                    try {
                        const response = await fetch(`https://kefu.chacaitx.cn/api/admin/cs/${this.csId}/miniapps`);
                        if (response.ok) {
                            const data = await response.json();
                            this.miniApps = Array.isArray(data) ? data : [];
                        } else {
                            this.miniApps = [];
                        }
                    } catch (err) {
                        console.error('åŠ è½½å°ç¨‹åºåˆ—è¡¨å¤±è´¥:', err);
                        this.miniApps = [];
                    }
                },
                async loadUsers() {
                    try {
                        const response = await fetch(`https://kefu.chacaitx.cn/api/admin/cs/${this.csId}/users`);
                        if (response.ok) {
                            const data = await response.json();
                            const users = Array.isArray(data) ? data : [];
                            // æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
                            users.sort((a, b) => {
                                const timeA = a.LastMessageTime ? new Date(a.LastMessageTime).getTime() : 0;
                                const timeB = b.LastMessageTime ? new Date(b.LastMessageTime).getTime() : 0;
                                return timeB - timeA; // é™åºï¼Œæœ€æ–°çš„åœ¨å‰
                            });
                            this.users = users;
                        } else {
                            this.users = [];
                        }
                    } catch (err) {
                        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', err);
                        this.users = [];
                    }
                },
                async selectUser(user) {
                    this.selectedUser = user;
                    this.selectedUserId = user.ID;
                    await this.loadMessages(user.ID);
                    // åŠ è½½æ¶ˆæ¯ååˆ·æ–°ç”¨æˆ·åˆ—è¡¨ï¼Œæ›´æ–°æœªè¯»æ¶ˆæ¯æ•°
                    await this.loadUsers();
                },
                async loadMessages(userId) {
                    try {
                        const response = await fetch(`https://kefu.chacaitx.cn/api/chat/cs/${this.csId}/user/${userId}/messages`);
                        if (response.ok) {
                            const data = await response.json();
                            this.messages = Array.isArray(data) ? data : [];
                            this.$nextTick(() => {
                                this.scrollToBottom();
                            });
                        } else {
                            this.messages = [];
                        }
                    } catch (err) {
                        console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', err);
                        this.messages = [];
                    }
                },
                connectWebSocket() {
                    if (!this.csId) return;
                    
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//kefu.chacaitx.cn/api/chat/ws/${this.csId}`;
                    
                    try {
                        this.ws = new WebSocket(wsUrl);
                        
                        this.ws.onopen = () => {
                            console.log('WebSocket è¿æ¥æˆåŠŸ');
                            this.error = '';
                            // å®šæœŸåˆ·æ–°ç”¨æˆ·åˆ—è¡¨ä»¥æ›´æ–°åœ¨çº¿çŠ¶æ€
                            if (this.userListRefreshTimer) {
                                clearInterval(this.userListRefreshTimer);
                            }
                            this.userListRefreshTimer = setInterval(() => {
                                this.loadUsers();
                                // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„ç”¨æˆ·ï¼Œä¹Ÿåˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
                                if (this.selectedUserId) {
                                    this.loadMessages(this.selectedUserId);
                                }
                            }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œæ›´åŠæ—¶

                            // è¿æ¥æˆåŠŸååˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                            this.loadUsers();
                        };
                        
                        this.ws.onmessage = (event) => {
                            try {
                                const msg = JSON.parse(event.data);
                                // å¦‚æœæ¶ˆæ¯æ¥è‡ªå½“å‰é€‰ä¸­çš„ç”¨æˆ·ï¼Œç«‹å³æ›´æ–°å¯¹è¯æ¡†
                                if (this.selectedUserId && msg.UserID === this.selectedUserId) {
                                    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
                                    const exists = this.messages.some(m => m.ID === msg.ID);
                                    if (!exists) {
                                        this.messages.push(msg);
                                        this.$nextTick(() => {
                                            this.scrollToBottom();
                                        });
                                    } else {
                                        // å¦‚æœå·²å­˜åœ¨ï¼Œé‡æ–°åŠ è½½æ¶ˆæ¯åˆ—è¡¨ä»¥ç¡®ä¿åŒæ­¥
                                        this.loadMessages(this.selectedUserId);
                                    }
                                } else {
                                    // å¦‚æœæ¶ˆæ¯æ¥è‡ªå…¶ä»–ç”¨æˆ·ï¼Œä¹Ÿéœ€è¦é‡æ–°åŠ è½½å½“å‰å¯¹è¯æ¡†ï¼ˆå¯èƒ½ç”¨æˆ·åˆ‡æ¢äº†ï¼‰
                                    if (this.selectedUserId) {
                                        this.loadMessages(this.selectedUserId);
                                    }
                                }
                                // ç«‹å³åˆ·æ–°ç”¨æˆ·åˆ—è¡¨ï¼Œæ–°æ¶ˆæ¯çš„ç”¨æˆ·ä¼šæ’åˆ°æœ€ä¸Šé¢
                                this.loadUsers();
                            } catch (err) {
                                console.error('è§£ææ¶ˆæ¯å¤±è´¥:', err);
                            }
                        };
                        
                        this.ws.onerror = (error) => {
                            console.error('WebSocket é”™è¯¯:', error);
                            this.error = 'WebSocket è¿æ¥é”™è¯¯ï¼Œæ­£åœ¨é‡è¿...';
                        };
                        
                        this.ws.onclose = (event) => {
                            console.log('WebSocket è¿æ¥å…³é—­', event.code, event.reason);
                            // æ¸…é™¤å®šæ—¶å™¨
                            if (this.userListRefreshTimer) {
                                clearInterval(this.userListRefreshTimer);
                                this.userListRefreshTimer = null;
                            }
                            // å¦‚æœä¸æ˜¯ä¸»åŠ¨å…³é—­ï¼Œåˆ™ç«‹å³å°è¯•é‡è¿
                            if (this.loggedIn && this.csId) {
                                console.log('ç«‹å³å°è¯•é‡è¿...');
                                // ä½¿ç”¨å¾ˆå°çš„å»¶è¿Ÿé¿å…è¿‡äºé¢‘ç¹çš„é‡è¿
                                setTimeout(() => {
                                    if (this.loggedIn && this.csId) {
                                        this.connectWebSocket();
                                    }
                                }, 100);
                            }
                        };
                    } catch (err) {
                        console.error('åˆ›å»ºWebSocketå¤±è´¥:', err);
                        this.error = 'WebSocket è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢';
                    }
                },
                async sendMessage() {
                    if (!this.message.trim() || !this.selectedUser) return;
                    
                    const content = this.message.trim();
                    this.message = ''; // å…ˆæ¸…ç©ºè¾“å…¥æ¡†
                    
                    try {
                        const response = await fetch('https://kefu.chacaitx.cn/api/chat/cs/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                UserID: this.selectedUser.ID,
                                CustomerServiceID: this.csId,
                                Content: content
                            })
                        });
                        
                        if (response.ok) {
                            await this.loadMessages(this.selectedUser.ID);
                            this.loadUsers();
                        } else {
                            this.error = 'å‘é€å¤±è´¥';
                            this.message = content; // å¤±è´¥æ—¶æ¢å¤å†…å®¹
                        }
                    } catch (err) {
                        this.error = 'å‘é€é”™è¯¯: ' + err.message;
                        this.message = content; // å¤±è´¥æ—¶æ¢å¤å†…å®¹
                    }
                },
                async sendImage(event) {
                    if (!this.selectedUser) return;
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    try {
                        const response = await fetch('https://kefu.chacaitx.cn/api/chat/upload', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (response.ok && data.url) {
                            const saveResponse = await fetch('https://kefu.chacaitx.cn/api/chat/cs/send', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    UserID: this.selectedUser.ID,
                                    CustomerServiceID: this.csId,
                                    ImageURL: data.url
                                })
                            });
                            
                            if (saveResponse.ok) {
                                await this.loadMessages(this.selectedUser.ID);
                                this.loadUsers();
                            }
                        }
                    } catch (err) {
                        this.error = 'ä¸Šä¼ å¤±è´¥: ' + err.message;
                    }
                    event.target.value = '';
                },
                handlePaste(event) {
                    const items = event.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            event.preventDefault();
                            const file = items[i].getAsFile();
                            this.uploadAndSendImage(file);
                            return;
                        }
                    }
                },
                handleDrop(event) {
                    event.preventDefault();
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            if (files[i].type.startsWith('image/')) {
                                this.uploadAndSendImage(files[i]);
                                break; // åªå¤„ç†ç¬¬ä¸€ä¸ªå›¾ç‰‡
                            }
                        }
                    }
                },
                async uploadAndSendImage(file) {
                    if (!this.selectedUser) return;
                    
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    try {
                        const response = await fetch('https://kefu.chacaitx.cn/api/chat/upload', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (response.ok && data.url) {
                            // é€šè¿‡APIä¿å­˜åˆ°æ•°æ®åº“
                            const saveResponse = await fetch('https://kefu.chacaitx.cn/api/chat/cs/send', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    UserID: this.selectedUser.ID,
                                    CustomerServiceID: this.csId,
                                    ImageURL: data.url
                                })
                            });
                            
                            if (saveResponse.ok) {
                                await this.loadMessages(this.selectedUser.ID);
                                this.loadUsers();
                            }
                        } else {
                            this.error = data.error || 'ä¸Šä¼ å¤±è´¥';
                        }
                    } catch (err) {
                        this.error = 'ä¸Šä¼ å¤±è´¥: ' + err.message;
                    }
                },
                viewImage(url) {
                    this.viewingImage = url;
                },
                formatTime(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                },
                scrollToBottom() {
                    const container = this.$refs.messagesContainer;
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                },
                async loadQRCode() {
                    if (!this.csId) return;
                    
                    this.qrCodeLoading = true;
                    this.qrCodeError = '';
                    this.qrCodeUrl = '';
                    
                    try {
                        const response = await fetch(`https://kefu.chacaitx.cn/api/chat/cs/${this.csId}/qrcode`);
                        if (response.ok) {
                            const blob = await response.blob();
                            this.qrCodeUrl = URL.createObjectURL(blob);
                        } else {
                            const data = await response.json();
                            this.qrCodeError = data.error || 'è·å–äºŒç»´ç å¤±è´¥';
                        }
                    } catch (err) {
                        this.qrCodeError = 'ç½‘ç»œé”™è¯¯: ' + err.message;
                    } finally {
                        this.qrCodeLoading = false;
                    }
                },
                async loadWelcomeMessage() {
                    if (!this.csId) return;
                    
                    try {
                        const response = await fetch(`https://kefu.chacaitx.cn/api/admin/cs/${this.csId}/welcome`);
                        if (response.ok) {
                            const data = await response.json();
                            this.welcomeMessage = data.WelcomeMessage || '';
                        }
                    } catch (err) {
                        console.error('åŠ è½½æ¬¢è¿è¯­å¤±è´¥:', err);
                    }
                },
                async saveWelcomeMessage() {
                    if (!this.csId) return;
                    
                    try {
                        const response = await fetch(`https://kefu.chacaitx.cn/api/admin/cs/${this.csId}/welcome`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ WelcomeMessage: this.welcomeMessage })
                        });
                        
                        if (response.ok) {
                            this.showWelcomeModal = false;
                            alert('æ¬¢è¿è¯­è®¾ç½®æˆåŠŸï¼');
                        } else {
                            const data = await response.json();
                            alert('è®¾ç½®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } catch (err) {
                        alert('ç½‘ç»œé”™è¯¯: ' + err.message);
                    }
                },
                async requestPushAuth() {
                    if (!this.selectedUser) {
                        alert('è¯·å…ˆé€‰æ‹©ç”¨æˆ·');
                        return;
                    }
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æˆæƒè®¢é˜…
                    if (!this.selectedUser.Subscribed) {
                        alert('è¯¥ç”¨æˆ·æœªæˆæƒè®¢é˜…æ¶ˆæ¯ï¼Œæ— æ³•æ¨é€');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`https://kefu.chacaitx.cn/api/chat/cs/${this.csId}/user/${this.selectedUser.ID}/push`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            alert('æ¨é€æé†’å·²å‘é€');
                        } else {
                            const data = await response.json();
                            alert('æ¨é€å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } catch (err) {
                        alert('ç½‘ç»œé”™è¯¯: ' + err.message);
                    }
                },
                showDeleteUserOption(user, event) {
                    event.stopPropagation();
                    if (confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· #${user.ID} å—ï¼Ÿ\n\nåˆ é™¤åå°†åŒæ—¶åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰èŠå¤©è®°å½•ã€‚`)) {
                        this.deleteUser(user.ID);
                    }
                },
                async deleteUser(userId) {
                    try {
                        const response = await fetch(`https://kefu.chacaitx.cn/api/admin/cs/${this.csId}/user/${userId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            alert('ç”¨æˆ·å·²åˆ é™¤');
                            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ç”¨æˆ·ï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€
                            if (this.selectedUser && this.selectedUser.ID === userId) {
                                this.selectedUser = null;
                                this.selectedUserId = null;
                                this.messages = [];
                            }
                            // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                            this.loadUsers();
                        } else {
                            const data = await response.json();
                            alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } catch (err) {
                        alert('ç½‘ç»œé”™è¯¯: ' + err.message);
                    }
                },
                logout() {
                    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                        if (this.ws) {
                            this.ws.close();
                        }
                        // æ¸…é™¤å®šæ—¶å™¨
                        if (this.userListRefreshTimer) {
                            clearInterval(this.userListRefreshTimer);
                            this.userListRefreshTimer = null;
                        }
                        // æ¸…é™¤ç™»å½•çŠ¶æ€
                        localStorage.removeItem('csId');
                        localStorage.removeItem('csName');
                        this.loggedIn = false;
                        this.csId = null;
                        this.csName = '';
                        this.csPass = '';
                        this.users = [];
                        this.selectedUser = null;
                        this.messages = [];
                        this.showQRCode = false;
                        this.qrCodeUrl = '';
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>