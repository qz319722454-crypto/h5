#!/bin/bash

# 推送诊断脚本

echo "=========================================="
echo "推送诊断工具"
echo "=========================================="
echo ""

# 检查 Docker 容器是否存在
if ! docker ps | grep -q h5-backend; then
    echo "❌ 错误: h5-backend 容器未运行"
    exit 1
fi

echo "1. 查看最近的推送日志（最近20条）"
echo "----------------------------------------"
docker logs h5-backend --tail 500 | grep -E "\[推送\]" | tail -20
echo ""

echo "2. 检查推送失败的原因"
echo "----------------------------------------"
echo "查看推送失败的错误码："
docker logs h5-backend --tail 500 | grep -E "\[推送\].*❌|\[推送\].*⚠️" | tail -10
echo ""

echo "3. 检查推送成功的记录"
echo "----------------------------------------"
echo "查看推送成功的记录："
docker logs h5-backend --tail 500 | grep -E "\[推送\].*✅" | tail -5
echo ""

echo "4. 常见问题排查"
echo "----------------------------------------"
echo "如果看到以下错误，请检查："
echo ""
echo "❌ 用户未订阅"
echo "   → 用户需要在小程序中授权订阅消息"
echo ""
echo "⏭️  用户在线，跳过推送"
echo "   → 这是正常的，用户在线时不推送"
echo "   → 可以关闭小程序或等待1分钟后测试"
echo ""
echo "❌ 模板ID未配置"
echo "   → 需要在管理后台配置小程序的模板ID"
echo ""
echo "⚠️  错误码47003: 参数错误"
echo "   → 模板字段名称可能不正确"
echo "   → 当前使用: thing1(发送者), thing2(内容), time3(时间)"
echo "   → 请查看微信公众平台的模板配置，确认实际字段名称"
echo ""
echo "⚠️  错误码40037: 模板ID不正确"
echo "   → 模板ID配置错误，请检查管理后台的模板ID"
echo ""
echo "=========================================="
echo "提示："
echo "- 如果推送失败，请查看上面的错误信息"
echo "- 如果用户在线，推送会被跳过（这是正常的）"
echo "- 如果模板字段名称不对，需要根据实际模板调整代码"
echo "=========================================="

